@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
@model IEnumerable<TaskJob>

<div class="container-fluid">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-12">
                    <a href="@Url.Action("Create", "Task")" class="btn btn-outline-info"> Create a new task</a>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <table class="table table-striped table-hover w-100">
                        <tr>
                            <th>
                                ID
                            </th>
                            <th>
                                Name
                            </th>
                            <th>
                                Description
                            </th>
                            <th>
                                Category name
                            </th>
                            <th>
                                Account Name
                            </th>
                            <th>
                                Actions
                            </th>
                        </tr>
                        @foreach (var t in Model)
                        {
                            <tr>
                                <td>
                                    @t.Id
                                </td>
                                <td>
                                    @{
                                        string nameId = "input-name-task" + t.Id;
                                        string descriptionId = "input-description-task" + t.Id;
                                    }
                                    <input type="text" class="form-control w-100 input-form-task" name="name" value="@t.Name"
                                           id="@nameId"
                                           disabled />
                                </td>
                                <td>

                                    <input type="text" class="form-control w-100 input-form-task" name="name" value="@t.Description"
                                           id="@descriptionId"
                                           disabled />
                                </td>
                                <td>
                                    @t.Category.Name
                                </td>
                                <td>
                                    @t.Account.Fullname
                                </td>
                                <td>
                                    <button class="btn btn-outline-warning w-100" onclick="enableEditing(@t.Id)" id="btnEnableEditing">
                                        Edit
                                    </button>
                                    <button class="btn btn-outline-success w-100 d-none" onclick="submitEdit(@t.Id)" id="btnSaveEdit">
                                        Save
                                    </button>

                                    <form asp-action="RemoveTask" method="POST">
                                        <input type="number" name="Id" value="@t.Id" class="d-none" />
                                        <button class="btn btn-outline-danger w-100">
                                            Remove
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function enableEditing(id){
        document.getElementById("btnSaveEdit").classList.remove("d-none");
        document.getElementById("btnEnableEditing").classList.add("d-none");
        var inputName = document.getElementById("input-name-task" + id);
        var inputDescription = document.getElementById("input-description-task" + id)
        inputName.disabled = false;
        inputDescription.disabled = false;
    }

    function submitEdit(id){
         var inputName = document.getElementById("input-name-task" + id)
         var inputDescription = document.getElementById("input-description-task" + id)
        // send ajax request
         var xhr = new XMLHttpRequest();
         xhr.open('POST','/Task/EditTask', true);
         xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');

         xhr.onload =  function(){
             if(xhr.status == 200){
                 var response = JSON.parse(xhr.responseText);
                 if(response.success){
                     //update view
                      inputName.disabled = true;
                      inputDescription.disabled = true;
                      document.getElementById("btnSaveEdit").classList.add("d-none");
                        document.getElementById("btnEnableEditing").classList.remove("d-none");
                 }else{
                      alert("Error occured!");
                 }
             }else{
                 alert("Error occured!");
             }
         }

         xhr.onerror = function(){
              inputName.disabled = true;
              inputDescription.disabled = true;
              alert("Error occured!");
         }

         var data = 'id=' + encodeURIComponent(id) +
                    '&name=' + encodeURIComponent(inputName.value.trim()) +
                    '&description='+ encodeURIComponent(inputDescription.value.trim());
         xhr.send(data);
    }
</script>
